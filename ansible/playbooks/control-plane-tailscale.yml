---
# =============================================================================
# Tailscale Bootstrap Playbook
# =============================================================================
# This playbook:
# 1. Configures VLAN 10 on Proxmox host with NAT for internet access
# 2. Installs Tailscale on control plane container
# 3. Configures Tailscale
# Note: VLAN 10 and NAT rules are kept permanently for container connectivity
# =============================================================================

- name: Configure VLAN 10 on Proxmox with NAT
  hosts: proxmox
  gather_facts: false

  tasks:
    - name: Check if vmbr0 is VLAN-aware
      ansible.builtin.shell:
        cmd: grep -A 10 "iface vmbr0" /etc/network/interfaces | grep "bridge-vlan-aware"
      register: vlan_aware_check
      failed_when: false
      changed_when: false

    - name: Enable VLAN awareness on vmbr0
      ansible.builtin.lineinfile:
        path: /etc/network/interfaces
        insertafter: '^iface vmbr0 inet static'
        line: '        bridge-vlan-aware yes'
        state: present
      when: vlan_aware_check.rc != 0

    - name: Apply network configuration
      ansible.builtin.command:
        cmd: ifreload vmbr0
      when: vlan_aware_check.rc != 0
      changed_when: true

    - name: Wait for bridge to reinitialize
      ansible.builtin.pause:
        seconds: 5
      when: vlan_aware_check.rc != 0

    - name: Add VLAN 10 to bridge
      ansible.builtin.command:
        cmd: bridge vlan add vid 10 dev vmbr0 self
      failed_when: false
      changed_when: true

    - name: Create VLAN 10 interface
      ansible.builtin.command:
        cmd: ip link add link vmbr0 name vmbr0.10 type vlan id 10
      failed_when: false
      changed_when: true

    - name: Bring up VLAN 10 interface
      ansible.builtin.command:
        cmd: ip link set vmbr0.10 up
      changed_when: true

    - name: Add IP address to VLAN 10 interface
      ansible.builtin.command:
        cmd: ip addr add 192.168.10.1/24 dev vmbr0.10
      failed_when: false
      changed_when: true

    - name: Enable IP forwarding
      ansible.builtin.command:
        cmd: sysctl -w net.ipv4.ip_forward=1
      changed_when: true

    - name: Add NAT rule for VLAN 10
      ansible.builtin.command:
        cmd: iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o vmbr0 -j MASQUERADE
      changed_when: true

    - name: Allow forwarding from VLAN 10
      ansible.builtin.command:
        cmd: iptables -A FORWARD -i vmbr0.10 -o vmbr0 -j ACCEPT
      changed_when: true

    - name: Allow return traffic to VLAN 10
      ansible.builtin.command:
        cmd: iptables -A FORWARD -i vmbr0 -o vmbr0.10 -m state --state RELATED,ESTABLISHED -j ACCEPT
      changed_when: true

    - name: Check if container 100 is running
      ansible.builtin.command:
        cmd: pct status 100
      register: pct_status
      changed_when: false

    - name: Start container if not running
      ansible.builtin.command:
        cmd: pct start 100
      when: "'running' not in pct_status.stdout"
      changed_when: true

    - name: Wait for container to fully boot
      ansible.builtin.pause:
        seconds: 1

    - name: Test connectivity to control plane
      ansible.builtin.command:
        cmd: ping -c 2 192.168.10.99
      register: ping_result
      changed_when: false
      retries: 3
      delay: 5
      until: ping_result.rc == 0

- name: Install and configure Tailscale on control plane
  hosts: proxmox
  gather_facts: false

  vars_files:
    - ../group_vars/all/vault.yml

  vars:
    tailscale_authkey: "{{ vault_tailscale_authkey | default('') }}"  # Loaded from vault
    tailscale_args: "--ssh --accept-routes"

  tasks:
    - name: Install Tailscale in container
      ansible.builtin.shell:
        cmd: |
          pct exec 100 -- bash -c '
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq
            apt-get install -y -qq curl ca-certificates
            curl -fsSL https://tailscale.com/install.sh | sh
          '
      changed_when: true
      async: 300
      poll: 5

    - name: Enable TUN device for container
      ansible.builtin.command:
        cmd: pct set 100 --features nesting=1,keyctl=1
      changed_when: true

    - name: Add TUN device to container
      ansible.builtin.lineinfile:
        path: /etc/pve/lxc/100.conf
        line: 'lxc.cgroup2.devices.allow: c 10:200 rwm'
        state: present

    - name: Add TUN device mount
      ansible.builtin.lineinfile:
        path: /etc/pve/lxc/100.conf
        line: 'lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file'
        state: present

    - name: Stop container to apply TUN device
      ansible.builtin.command:
        cmd: pct stop 100
      changed_when: true

    - name: Wait for container to stop
      ansible.builtin.pause:
        seconds: 3

    - name: Start container with TUN device
      ansible.builtin.command:
        cmd: pct start 100
      changed_when: true

    - name: Wait for container to fully start
      ansible.builtin.pause:
        seconds: 10

    - name: Enable Tailscale daemon on boot
      ansible.builtin.command:
        cmd: pct exec 100 -- systemctl enable tailscaled
      changed_when: true

    - name: Start Tailscale daemon
      ansible.builtin.command:
        cmd: pct exec 100 -- systemctl start tailscaled
      changed_when: true

    - name: Wait for Tailscale daemon to initialize
      ansible.builtin.pause:
        seconds: 5

    - name: Check if Tailscale is already connected
      ansible.builtin.command:
        cmd: pct exec 100 -- tailscale status --json
      register: tailscale_status
      failed_when: false
      changed_when: false

    - name: Connect to Tailscale with auth key
      ansible.builtin.command:
        cmd: pct exec 100 -- tailscale up --advertise-routes=192.168.10.0/24 --accept-routes --ssh --authkey={{ tailscale_authkey }}
      register: tailscale_up_auth
      changed_when: true

    - name: Fail if Tailscale connection failed
      ansible.builtin.fail:
        msg: "Tailscale connection failed: {{ tailscale_up_auth.stderr }}"
      when:
        - tailscale_up_auth is defined
        - tailscale_up_auth.rc != 0

    - name: Get Tailscale IPv4 address
      ansible.builtin.command:
        cmd: pct exec 100 -- tailscale ip -4
      register: tailscale_ipv4
      changed_when: false

    - name: Get Tailscale IPv6 address
      ansible.builtin.command:
        cmd: pct exec 100 -- tailscale ip -6
      register: tailscale_ipv6
      changed_when: false
      failed_when: false

    - name: Display Tailscale IP addresses
      ansible.builtin.debug:
        msg:
          - "Tailscale IPv4: {{ tailscale_ipv4.stdout }}"
          - "Tailscale IPv6: {{ tailscale_ipv6.stdout | default('N/A') }}"

    - name: Save Tailscale IP to local file
      ansible.builtin.copy:
        content: |
          # Control Plane Tailscale IP
          {{ tailscale_ipv4.stdout }}
        dest: /tmp/control-plane-tailscale-ip.txt
        mode: '0644'
      delegate_to: localhost

    - name: Update inventory with Tailscale IP
      ansible.builtin.lineinfile:
        path: ../inventory/hosts.yml
        regexp: '^\s+ansible_host:\s+.*\s+#\s+control_plane'
        line: '          ansible_host: {{ tailscale_ipv4.stdout }}  # control_plane'
        backrefs: false
      delegate_to: localhost

    - name: Add Tailscale IP to hostvars
      ansible.builtin.add_host:
        name: control
        ansible_host: "{{ tailscale_ipv4.stdout }}"
        groups: control_plane

- name: Final summary
  hosts: proxmox
  gather_facts: false

  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "TAILSCALE BOOTSTRAP COMPLETE!"
          - "============================================"
          - "✓ VLAN 10 configured with NAT"
          - "✓ Tailscale installed and connected"
          - "✓ Inventory updated with Tailscale IP"
          - "============================================"
