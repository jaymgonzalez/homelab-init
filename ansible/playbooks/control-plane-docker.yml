---
# =============================================================================
# Control Plane Docker Installation
# =============================================================================
# Installs Docker Engine on the control plane LXC for GitLab Runner
# =============================================================================

- name: Install Docker on Control Plane
  hosts: control_plane
  gather_facts: true

  tasks:
    # -------------------------------------------------------------------------
    # System Update
    # -------------------------------------------------------------------------
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    # -------------------------------------------------------------------------
    # Install Prerequisites
    # -------------------------------------------------------------------------
    - name: Install Docker prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present

    # -------------------------------------------------------------------------
    # Add Docker Repository
    # -------------------------------------------------------------------------
    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Dearmor Docker GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /etc/apt/keyrings/docker.asc > /etc/apt/keyrings/docker.gpg
        chmod 644 /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Get architecture
      ansible.builtin.command: dpkg --print-architecture
      register: arch
      changed_when: false

    - name: Get Debian release codename
      ansible.builtin.shell: . /etc/os-release && echo $VERSION_CODENAME
      register: debian_release
      changed_when: false

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ arch.stdout }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ debian_release.stdout }} stable"
        filename: docker
        state: present

    # -------------------------------------------------------------------------
    # Install Docker
    # -------------------------------------------------------------------------
    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    # -------------------------------------------------------------------------
    # Configure Docker
    # -------------------------------------------------------------------------
    - name: Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    # -------------------------------------------------------------------------
    # Verify Installation
    # -------------------------------------------------------------------------
    - name: Get Docker version
      ansible.builtin.command: docker --version
      register: docker_version
      changed_when: false

    - name: Test Docker with hello-world
      ansible.builtin.command: docker run --rm hello-world
      register: docker_test
      changed_when: false

    # -------------------------------------------------------------------------
    # Add Docker Aliases
    # -------------------------------------------------------------------------
    - name: Add Docker aliases to bashrc
      ansible.builtin.blockinfile:
        path: /root/.bashrc
        block: |
          # Docker Aliases
          alias d='docker'
          alias dps='docker ps'
          alias dpsa='docker ps -a'
          alias di='docker images'
          alias dc='docker compose'
          alias dcu='docker compose up -d'
          alias dcd='docker compose down'
          alias dcl='docker compose logs -f'
        marker: "# {mark} ANSIBLE MANAGED - DOCKER ALIASES"

    # -------------------------------------------------------------------------
    # Summary
    # -------------------------------------------------------------------------
    - name: Installation summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "DOCKER INSTALLATION COMPLETE!"
          - "============================================"
          - "{{ docker_version.stdout }}"
          - "Docker service: running and enabled"
          - "Test result: {{ 'SUCCESS' if 'Hello from Docker!' in docker_test.stdout else 'FAILED' }}"
          - ""
          - "Useful aliases added:"
          - "  d       - docker"
          - "  dps     - docker ps"
          - "  di      - docker images"
          - "  dc      - docker compose"
          - "============================================"
